# ZWToken Contracts Structure

This directory contains all smart contracts for ZWToken. Contracts are modularized by function for easier maintenance and testing.

## ğŸ“ File Structure

```
contracts/
â”œâ”€â”€ ZWERC20.sol                    # Main contract: ZK Wrapper Token
â”œâ”€â”€ Groth16Verifier.sol           # ZK proof verifier (generated by snarkjs)
â”œâ”€â”€ interfaces/                    # Interface definitions
â”‚   â””â”€â”€ ISnarkVerifier.sol        # ZK proof verifier interface
â”œâ”€â”€ utils/                         # Utility contracts
â”‚   â””â”€â”€ PoseidonMerkleTree.sol    # Poseidon Merkle Tree implementation
â””â”€â”€ mocks/                         # Test helper contracts
    â”œâ”€â”€ ERC20Mock.sol             # Mock ERC20 token
    â””â”€â”€ MockVerifier.sol          # Mock ZK verifier
```

## ğŸ“„ Contract Description

### Main Contract

#### `ZWERC20.sol`

ZK Wrapper Token main contract (implements IERC8065), provides the following functionality:

- **Deposit/Withdraw**: Wrap/unwrap underlying ERC20 tokens
- **Transfer**: Standard ERC20 transfer with automatic first receipt commitment recording
- **Remint**: Privacy transfer or withdrawal using ZK proofs
- **First Receipt Tracking**: Records the amount of tokens each address first receives

Inheritance:

- `ERC20` (OpenZeppelin)
- `PoseidonMerkleTree` (custom utility contract)
- `IERC8065` (interface implementation)

### Interfaces

#### `interfaces/ISnarkVerifier.sol`

Standard interface for Groth16 ZK-SNARK verifier.

**Methods**:

- `verifyProof()`: Verify ZK proof validity

**Implementation**:

- `Groth16Verifier.sol`: Auto-generated from circuit by snarkjs

### Utility Contracts

#### `utils/PoseidonMerkleTree.sol`

Abstract implementation of incremental Poseidon Merkle Tree.

**Features**:

- âœ… Incremental updates (no need to rebuild entire tree)
- âœ… ZK-friendly (uses Poseidon hash)
- âœ… Gas-optimized (only stores filled subtrees)
- âœ… Historical root verification support

**Core Functions**:

- `_insertLeaf()`: Insert new leaf node
- `_poseidonHash()`: Compute Poseidon hash
- `isKnownRoot[]`: Verify if historical root is valid

**State Variables**:

- `root`: Current Merkle root
- `nextIndex`: Next insertion position
- `zeros[]`: Zero value hashes for each level
- `filledSubtrees[]`: Rightmost filled node for each level

## ğŸ”§ Dependencies

### External Libraries

1. **OpenZeppelin Contracts** (v5.x)

   - `ERC20`: Standard ERC20 implementation
   - `IERC20`: ERC20 interface
   - `SafeERC20`: Safe ERC20 calls

2. **poseidon-solidity**
   - `PoseidonT3`: Poseidon hash function (2 inputs)

### Install Dependencies

```bash
npm install @openzeppelin/contracts poseidon-solidity
```

## ğŸ¯ Contract Interaction Flow

### 1. Deposit Flow

```
User â†’ deposit(amount) â†’ ZWToken (mint)
     â†“
Underlying Token transferred to contract
```

### 2. First Receipt Tracking

```
transfer/claim â†’ _recordCommitmentIfNeeded()
                 â†“
                 hasFirstReceiptRecorded[to] = true
                 â†“
                 commitment = Poseidon(address, firstAmount)
                 â†“
                 _insertLeaf(commitment) â†’ Update Merkle Tree
```

### 3. Remint Flow (Privacy Transfer)

```
User â†’ remint(to, id, amount, withdrawUnderlying, data)
     â†“
Verify root is a valid historical root
     â†“
Verify nullifier has not been used
     â†“
Verify ZK proof (via ISnarkVerifier)
     â†“
If withdrawUnderlying=false: Mint ZWToken to to address
If withdrawUnderlying=true: Transfer out underlying tokens
     â†“
Record commitment (if first receipt and minting)
```

## ğŸ” Security Features

1. **Anti-replay Attack**: Uses `nullifierUsed` mapping
2. **Historical Root Support**: Allows using old Merkle roots (supports concurrent claims)
3. **ZK Proof Verification**: All claims must provide valid zero-knowledge proofs
4. **First Receipt Immutability**: Once recorded, cannot be modified

## ğŸ“Š Gas Optimization

- **Incremental Merkle Tree**: Only updates necessary nodes, avoids rebuilding entire tree
- **Sparse Tree**: Doesn't store all nodes, only stores `filledSubtrees`
- **Historical Roots**: Uses mapping instead of array, saves gas

## ğŸ§ª Testing

Contract tests are located in `test/` directory:

- `e2e.test.js`: End-to-end tests
- `commitment.test.js`: Commitment recording tests
- `remint.test.js`: Remint functionality tests
- `gas-profile.test.js`: Gas analysis tests

Run tests:

```bash
npx hardhat test
```

## ğŸ“š More Information

- Circuit code: `circuits/remint.circom`
- Frontend application: `website/`
