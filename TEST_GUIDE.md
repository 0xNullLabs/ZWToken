# ZWToken POC æµ‹è¯•æŒ‡å—

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•è°ƒé€š `eth_getProof` æ–¹æ³•æµç¨‹çš„ä¸‰ç§æ–¹æ¡ˆã€‚

## ðŸŽ¯ é—®é¢˜èƒŒæ™¯

Hardhat æœ¬åœ°ç½‘ç»œé»˜è®¤ä¸æ”¯æŒ `eth_getProof` æ–¹æ³•ï¼Œè¿™æ˜¯ EIP-1186 å®šä¹‰çš„æ ‡å‡† RPC æ–¹æ³•ï¼Œç”¨äºŽèŽ·å–è´¦æˆ·å’Œå­˜å‚¨çš„ Merkle è¯æ˜Žã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šMock æµ‹è¯•ï¼ˆæœ€ç®€å•ï¼ŒæŽ¨èç”¨äºŽå¿«é€ŸéªŒè¯ï¼‰

**ä¼˜ç‚¹**ï¼šæ— éœ€é¢å¤–å·¥å…·ï¼Œæµ‹è¯•é€Ÿåº¦å¿«  
**ç¼ºç‚¹**ï¼šè·³è¿‡äº† `eth_getProof`ï¼Œæ— æ³•éªŒè¯å®Œæ•´çš„ MPT è¯æ˜Žæµç¨‹

```bash
# è¿è¡Œ mock æµ‹è¯•
npx hardhat test test/claim-mock.test.js

# æˆ–å•ç‹¬è¿è¡ŒåŽŸæœ‰çš„ claim æµ‹è¯•
npx hardhat test test/claim.test.js
```

è¿™ä¸ªæµ‹è¯•ä½¿ç”¨ `DevMockVerifier`ï¼Œè·³è¿‡äº†å®žé™…çš„çŠ¶æ€è¯æ˜ŽèŽ·å–å’ŒéªŒè¯ã€‚

---

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ Anvilï¼ˆæŽ¨èç”¨äºŽå®Œæ•´æµ‹è¯•ï¼‰

**ä¼˜ç‚¹**ï¼šå®Œæ•´æ”¯æŒ `eth_getProof`ï¼ŒæŽ¥è¿‘çœŸå®žçŽ¯å¢ƒ  
**ç¼ºç‚¹**ï¼šéœ€è¦å®‰è£… Foundry

#### å®‰è£… Foundry/Anvil

```bash
# å®‰è£… Foundry
curl -L https://foundry.paradigm.xyz | bash
foundryup
```

#### è¿è¡Œæµ‹è¯•

```bash
# æ–¹å¼ 1ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæŽ¨èï¼‰
chmod +x scripts/test-with-anvil.sh
./scripts/test-with-anvil.sh

# æ–¹å¼ 2ï¼šæ‰‹åŠ¨å¯åŠ¨
# ç»ˆç«¯ 1ï¼šå¯åŠ¨ Anvil
anvil --port 8545

# ç»ˆç«¯ 2ï¼šè¿è¡Œæµ‹è¯•
npx hardhat test test/e2e.test.js --network localhost
```

---

### æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ Hardhat Forking

**ä¼˜ç‚¹**ï¼šå¯ä»¥ fork çœŸå®žç½‘ç»œï¼ˆå¦‚ä¸»ç½‘ã€Sepoliaï¼‰  
**ç¼ºç‚¹**ï¼šéœ€è¦ RPC èŠ‚ç‚¹ï¼Œé€Ÿåº¦è¾ƒæ…¢

#### é…ç½®çŽ¯å¢ƒå˜é‡

```bash
# åˆ›å»º .env æ–‡ä»¶
cat > .env << EOF
# Alchemy/Infura æˆ–å…¶ä»– RPC æä¾›å•†
MAINNET_RPC_URL=https://eth-mainnet.g.alchemy.com/v2/YOUR_API_KEY
SEPOLIA_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_API_KEY
EOF
```

#### å®‰è£… dotenv

```bash
npm install dotenv
```

#### æ›´æ–° hardhat.config.js

åœ¨é…ç½®æ–‡ä»¶å¼€å¤´æ·»åŠ ï¼š

```javascript
require("dotenv").config();
```

#### è¿è¡Œ Fork æµ‹è¯•

```bash
# Fork ä¸»ç½‘æµ‹è¯•ï¼ˆéœ€è¦æœ‰å·²éƒ¨ç½²çš„åˆçº¦ï¼‰
HARDHAT_NETWORK=hardhat-fork npx hardhat test test/e2e.test.js

# æˆ–è€…åœ¨æµ‹è¯•ä¸­åŠ¨æ€å¯ç”¨ forking
npx hardhat test test/e2e.test.js --fork https://eth-mainnet.g.alchemy.com/v2/YOUR_API_KEY
```

---

## ðŸ“Š æµ‹è¯•å¯¹æ¯”

| æ–¹æ¡ˆ         | eth_getProof | MPT éªŒè¯ | é€Ÿåº¦      | éš¾åº¦   | æŽ¨èåœºæ™¯          |
| ------------ | ------------ | -------- | --------- | ------ | ----------------- |
| Mock æµ‹è¯•    | âŒ           | âŒ       | âš¡ï¸âš¡ï¸âš¡ï¸ | â­     | å¿«é€Ÿå¼€å‘/å•å…ƒæµ‹è¯• |
| Anvil        | âœ…           | âœ…       | âš¡ï¸âš¡ï¸    | â­â­   | å®Œæ•´åŠŸèƒ½æµ‹è¯•      |
| Hardhat Fork | âœ…           | âœ…       | âš¡ï¸       | â­â­â­ | ä¸»ç½‘é›†æˆæµ‹è¯•      |

---

## ðŸ” éªŒè¯æµ‹è¯•ç»“æžœ

### æˆåŠŸçš„è¾“å‡ºç¤ºä¾‹

```
=== é˜¶æ®µ 1: è®¡ç®—éšç§åœ°å€å¹¶ deposit ===
Secret: 123456789
éšç§åœ°å€ A: 0x72710FbDbBA698C6C6fAF62e56fA396c0D79308B
åœ°å€ A çš„ ZKW ä½™é¢: 1000.0

=== é˜¶æ®µ 2: èŽ·å–çŠ¶æ€è¯æ˜Ž ===
ç›®æ ‡åŒºå—: 18
åŒºå—å“ˆå¸Œ: 0x84f7c8...
Storage proof èŽ·å–æˆåŠŸ
ä½™é¢å€¼: 0x...

=== é˜¶æ®µ 3: æž„é€ è¯æ˜Žè¾“å…¥ ===
Nullifier: 0x...

=== é˜¶æ®µ 4: æ‰§è¡Œ claim ===
âœ… Claim æˆåŠŸ
æŽ¥æ”¶è€…ä½™é¢: 100.0

=== æµ‹è¯•é˜²é‡æ”¾ ===
âœ… é˜²é‡æ”¾æµ‹è¯•é€šè¿‡
```

---

## ðŸ› å¸¸è§é—®é¢˜

### Q1: Anvil å¯åŠ¨å¤±è´¥

```bash
# æ£€æŸ¥ 8545 ç«¯å£æ˜¯å¦è¢«å ç”¨
lsof -i :8545

# ä½¿ç”¨å…¶ä»–ç«¯å£
anvil --port 8546
# ç„¶åŽåœ¨ hardhat.config.js ä¸­æ›´æ–° localhost URL
```

### Q2: eth_getProof è¿”å›žç©ºæ•°æ®

ç¡®ä¿ï¼š

1. ç›®æ ‡åŒºå—æœ‰è¶³å¤Ÿçš„åŽ†å²ï¼ˆä½¿ç”¨ `head-2` æˆ–æ›´æ—©çš„åŒºå—ï¼‰
2. åˆçº¦åœ°å€å’Œ storage slot è®¡ç®—æ­£ç¡®
3. å·²ç»æ‰§è¡Œäº†çŠ¶æ€ä¿®æ”¹ï¼ˆå¦‚ depositï¼‰

### Q3: Mock æµ‹è¯•é€šè¿‡ä½†çœŸå®žæµ‹è¯•å¤±è´¥

è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºï¼š

- Mock æµ‹è¯•è·³è¿‡äº† MPT éªŒè¯
- éœ€è¦å®žçŽ°å®Œæ•´çš„ Circom ç”µè·¯æ¥éªŒè¯çŠ¶æ€è¯æ˜Ž
- å½“å‰çš„ç”µè·¯æ–‡ä»¶ `airdrop_from_state_root.circom` è¿˜éœ€è¦æŽ¥å…¥çœŸå®žçš„ MPT éªŒè¯ç»„ä»¶

---

## ðŸ“ ä¸‹ä¸€æ­¥

1. **å®Œå–„ Circom ç”µè·¯**ï¼šæŽ¥å…¥ RLP/Keccak/MPT éªŒè¯ç»„ä»¶
2. **ç”ŸæˆçœŸå®žè¯æ˜Ž**ï¼šä½¿ç”¨ snarkjs ç”Ÿæˆ Groth16 è¯æ˜Ž
3. **æ›¿æ¢ Mock Verifier**ï¼šä½¿ç”¨çœŸå®žçš„ `Verifier.sol`
4. **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼šåœ¨ Anvil æˆ– Fork çŽ¯å¢ƒä¸­å®Œæ•´æµ‹è¯•

---

## ðŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆæŽ¨èæµç¨‹ï¼‰

```bash
# 1. è¿è¡Œ mock æµ‹è¯•ï¼ˆéªŒè¯åˆçº¦é€»è¾‘ï¼‰
npx hardhat test test/claim-mock.test.js

# 2. å®‰è£… Foundryï¼ˆå¦‚æžœè¿˜æ²¡æœ‰ï¼‰
curl -L https://foundry.paradigm.xyz | bash && foundryup

# 3. ä½¿ç”¨ Anvil è¿è¡Œå®Œæ•´æµ‹è¯•
./scripts/test-with-anvil.sh

# 4. æ£€æŸ¥æµ‹è¯•è¾“å‡ºï¼Œç¡®è®¤ eth_getProof æ­£å¸¸å·¥ä½œ
```

---

## ðŸ’¡ æç¤º

- **å¼€å‘é˜¶æ®µ**ï¼šä½¿ç”¨ Mock æµ‹è¯•å¿«é€Ÿè¿­ä»£
- **åŠŸèƒ½éªŒè¯**ï¼šä½¿ç”¨ Anvil æµ‹è¯•å®Œæ•´æµç¨‹
- **é›†æˆæµ‹è¯•**ï¼šä½¿ç”¨ Hardhat Fork æµ‹è¯•çœŸå®žçŽ¯å¢ƒ
- **ç”Ÿäº§éƒ¨ç½²å‰**ï¼šåœ¨æµ‹è¯•ç½‘ï¼ˆSepoliaï¼‰ä¸Šå®Œæ•´æµ‹è¯•
