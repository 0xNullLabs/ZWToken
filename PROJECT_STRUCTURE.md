# ZWToken Project Structure

ZK Wrapper Token - Privacy token wrapper based on zero-knowledge proofs

## ğŸ“ Project Directory Structure

```
ZWToken/
â”œâ”€â”€ contracts/                      # Solidity Smart Contracts
â”‚   â”œâ”€â”€ ZWERC20.sol                # Main contract (implements IERC8065)
â”‚   â”œâ”€â”€ Groth16Verifier.sol        # ZK proof verifier (generated by snarkjs)
â”‚   â”œâ”€â”€ interfaces/                # Interface definitions
â”‚   â”‚   â”œâ”€â”€ IERC8065.sol           # ERC-8065 interface
â”‚   â”‚   â””â”€â”€ ISnarkVerifier.sol     # Verifier interface
â”‚   â”œâ”€â”€ utils/                     # Utility contracts
â”‚   â”‚   â””â”€â”€ PoseidonMerkleTree.sol # Poseidon Merkle Tree implementation
â”‚   â”œâ”€â”€ mocks/                     # Mock contracts (for testing only)
â”‚   â”‚   â”œâ”€â”€ ERC20Mock.sol          # Mock ERC20 token
â”‚   â”‚   â””â”€â”€ MockVerifier.sol       # Mock ZK verifier
â”‚   â””â”€â”€ README.md                  # Contract documentation
â”‚
â”œâ”€â”€ circuits/                       # ZK Circuits
â”‚   â”œâ”€â”€ remint.circom              # Main circuit (~12K constraints)
â”‚   â””â”€â”€ out/                       # Compiled output
â”‚       â”œâ”€â”€ remint_js/             # JS witness generator
â”‚       â”œâ”€â”€ remint.wasm            # WASM witness generator
â”‚       â”œâ”€â”€ remint_final.zkey      # Proving key
â”‚       â””â”€â”€ verification_key.json  # Verification key
â”‚
â”œâ”€â”€ utils/                          # Common utilities
â”‚   â””â”€â”€ merkle-tree-utils.js       # Merkle Tree JS implementation
â”‚
â”œâ”€â”€ test/                           # Test files
â”‚   â”œâ”€â”€ e2e.test.js                # End-to-end tests
â”‚   â”œâ”€â”€ commitment.test.js         # Commitment recording tests
â”‚   â”œâ”€â”€ remint.test.js             # Remint functionality tests
â”‚   â”œâ”€â”€ gas-profile.test.js        # Gas analysis tests
â”‚   â””â”€â”€ zk-profile.test.js         # ZK performance tests
â”‚
â”œâ”€â”€ scripts/                        # Script tools
â”‚   â”œâ”€â”€ build_circuit.sh           # Circuit compilation script
â”‚   â””â”€â”€ deploy.js                  # Deployment script
â”‚
â”œâ”€â”€ website/                        # Frontend Web Application
â”‚
â”œâ”€â”€ deployments/                    # Deployment records
â”œâ”€â”€ artifacts/                      # Hardhat compilation artifacts
â”œâ”€â”€ cache/                          # Hardhat cache
â”œâ”€â”€ node_modules/                   # Dependencies
â”œâ”€â”€ hardhat.config.js              # Hardhat configuration
â”œâ”€â”€ package.json                   # Project dependencies
â””â”€â”€ README.md                      # Main project documentation
```

## ğŸ¯ Core Module Description

### 1. Smart Contract Layer (`contracts/`)

**Main Contract**:

- `ZWERC20.sol`: Core business logic
  - Deposit/Withdraw: Wrap/unwrap tokens
  - Transfer: Standard ERC20 transfer + commitment recording
  - Claim: Privacy transfer with ZK proof verification

**Utility Contracts** (`utils/`):

- `PoseidonMerkleTree.sol`: Poseidon hash Merkle Tree
  - Incremental updates
  - Historical root support
  - Gas-optimized design

**Interfaces** (`interfaces/`):

- `ISnarkVerifier.sol`: ZK proof verifier standard interface

### 2. ZK Circuit Layer (`circuits/`)

**Circuit Implementation**:

- `remint.circom`:
  - Verify secret â†’ privacy address derivation
  - Verify commitment is in Merkle tree
  - Verify remint amount â‰¤ commit amount
  - ~12K constraints (5-12 seconds proof generation)

**Compiled Artifacts** (`out/`):

- `remint.wasm`: WASM witness generator
- `remint_final.zkey`: Proving key
- `verification_key.json`: Verification key

### 3. Utility Layer (`utils/`)

**Shared JS Utilities**:

- `merkle-tree-utils.js`:
  - `IncrementalMerkleTree`: Simplified version (test/browser)
  - `PoseidonMerkleTree`: Full version (contract storage client)
  - Shared by 2 modules (test, client)

### 4. Frontend Web Application (`website/`)

**Features**:

- Browser-side ZK proof generation
- Contract interaction (deposit, transfer, remint, withdraw)
- Wallet connection

### 5. Test Layer (`test/`)

**Test Suites**:

- `e2e.test.js`: End-to-end tests
- `commitment.test.js`: Commitment recording logic
- `remint.test.js`: Remint functionality tests
- `gas-profile.test.js`: Gas analysis tests
- `zk-profile.test.js`: ZK performance tests

## ğŸ”§ Tech Stack

### Smart Contracts

- **Solidity**: ^0.8.20
- **Hardhat**: Development environment
- **OpenZeppelin**: ERC20 standard implementation
- **poseidon-solidity**: ZK-friendly hash function

### ZK Proofs

- **Circom**: Circuit language
- **snarkjs**: Proof generation/verification
- **Groth16**: Proof system (~200 bytes proof)

### Frontend Tools

- **ethers.js**: Ethereum interaction
- **circomlibjs**: Poseidon hash JS implementation

## ğŸš€ Quick Start

### 1. Install Dependencies

```bash
npm install
```

### 2. Compile Contracts

```bash
npx hardhat compile
```

### 3. Compile Circuit

```bash
./scripts/build_circuit.sh
```

### 4. Run Tests

```bash
npx hardhat test                    # All tests
npx hardhat test test/e2e.test.js  # E2E tests
```

## ğŸ“Š Data Flow

### Deposit â†’ Transfer â†’ Remint Flow

```
1. Alice deposits 1000 underlying tokens
   â†“
   ZWERC20.deposit(to, 0, amount) â†’ mint ZWT to recipient

2. Alice transfers 500 ZWT to privacy address
   â†“
   transfer() â†’ _update() â†’ _recordCommitmentIfNeeded()
   â†“
   commitment = Poseidon(addr20, 500)
   â†“
   _insertLeaf() â†’ Update Merkle tree
   â†“
   store commitment in leafs array

3. User generates ZK proof
   â†“
   Query commitments from contract storage
   â†“
   Locally rebuild Merkle tree + generate proof
   â†“
   Construct circuit inputs

4. User submits remint
   â†“
   ZWERC20.remint(to, id, amount, withdrawUnderlying, data)
   â†“
   Verify root in isKnownRoot
   â†“
   Verify nullifier not used
   â†“
   verifier.verifyProof() â†’ true
   â†“
   mint ZWT to recipient (or withdraw underlying)
   â†“
   _recordCommitmentIfNeeded() (if minting)
```

## ğŸ” Privacy Protection

1. **Burn Address**: Derived from secret (not linked to real identity)
2. **Commitment**: Poseidon(addr20, firstAmount) recorded on-chain
3. **Nullifier**: Prevents double claim, but doesn't reveal commitment
4. **ZK Proof**: Proves ownership of secret without revealing the secret itself

## ğŸ“š Documentation Index

- [Main README](./README.md): Project overview
- [Contract Documentation](./contracts/README.md): Smart contract details

## ğŸ¤ Contributing

Issues and Pull Requests are welcome!

## ğŸ“„ License

MIT License
